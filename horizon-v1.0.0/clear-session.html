<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar Sess√£o Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 0; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üßπ Limpeza de Sess√£o Supabase</h1>
    <p>Esta p√°gina ajuda a limpar sess√µes corrompidas do Supabase que causam erros de "Invalid Refresh Token".</p>
    
    <div id="status"></div>
    
    <button onclick="clearAll()">üóëÔ∏è Limpar Tudo (Sess√£o + Storage)</button>
    <button onclick="clearSupabaseOnly()">üéØ Limpar Apenas Supabase</button>
    <button onclick="checkSession()">üîç Verificar Sess√£o Atual</button>
    
    <div id="logs"></div>

    <script>
        // Configura√ß√£o do Supabase (as mesmas credenciais do .env)
        const SUPABASE_URL = 'https://isgupiyafzfnkrlyvaqr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzZ3VwaXlhZnpmbmtybHl2YXFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MjEwNjAsImV4cCI6MjA4MjI5NzA2MH0.4vK2bc_JY3vS2CRWVI6cH0furlveuCkWwlnLtnXg7LU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            document.getElementById('logs').appendChild(div);
        }

        async function clearAll() {
            log('üßπ Iniciando limpeza completa...', 'info');
            try {
                // 1. Logout do Supabase
                await supabase.auth.signOut({ scope: 'local' });
                log('‚úÖ Logout do Supabase realizado', 'success');
                
                // 2. Limpar localStorage
                const lsKeys = Object.keys(localStorage);
                const supabaseKeys = lsKeys.filter(key => key.includes('supabase'));
                supabaseKeys.forEach(key => localStorage.removeItem(key));
                log(`‚úÖ Removidas ${supabaseKeys.length} chaves do localStorage: ${supabaseKeys.join(', ')}`, 'success');
                
                // 3. Limpar sessionStorage
                const ssKeys = Object.keys(sessionStorage);
                const supabaseSsKeys = ssKeys.filter(key => key.includes('supabase'));
                supabaseSsKeys.forEach(key => sessionStorage.removeItem(key));
                log(`‚úÖ Removidas ${supabaseSsKeys.length} chaves do sessionStorage: ${supabaseSsKeys.join(', ')}`, 'success');
                
                log('üéâ Limpeza completa finalizada! Agora voc√™ pode fechar esta p√°gina e tentar novamente no app.', 'success');
                
            } catch (error) {
                log(`‚ùå Erro durante limpeza: ${error.message}`, 'error');
            }
        }

        async function clearSupabaseOnly() {
            log('üéØ Limpando apenas dados do Supabase...', 'info');
            try {
                await supabase.auth.signOut({ scope: 'local' });
                log('‚úÖ Logout do Supabase realizado', 'success');
                log('üéâ Limpeza do Supabase finalizada!', 'success');
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function checkSession() {
            log('üîç Verificando sess√£o atual...', 'info');
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`‚ùå Erro ao verificar sess√£o: ${error.message}`, 'error');
                    return;
                }
                
                if (data.session) {
                    log('‚úÖ Sess√£o ativa encontrada:', 'success');
                    log(`<pre>${JSON.stringify({
                        user: data.session.user?.email,
                        expires_at: new Date(data.session.expires_at * 1000).toLocaleString(),
                        token_type: data.session.token_type
                    }, null, 2)}</pre>`, 'info');
                } else {
                    log('‚ÑπÔ∏è Nenhuma sess√£o ativa', 'info');
                }
                
                // Verificar localStorage
                const lsKeys = Object.keys(localStorage).filter(key => key.includes('supabase'));
                if (lsKeys.length > 0) {
                    log(`üì¶ Dados no localStorage: ${lsKeys.join(', ')}`, 'info');
                } else {
                    log('üì¶ Nenhum dado do Supabase no localStorage', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Erro inesperado: ${error.message}`, 'error');
            }
        }

        // Verificar sess√£o automaticamente quando a p√°gina carregar
        window.onload = () => {
            log('üöÄ Utilit√°rio de limpeza carregado', 'info');
            checkSession();
        };
    </script>
</body>
</html>